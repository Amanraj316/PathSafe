<!DOCTYPE html>
<html>
<head>
    <title>Emergency Vehicle Routing</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; display: flex; margin: 0; }
        #map { height: 100vh; width: 80vw; cursor: crosshair; }
        #sidebar {
            width: 20vw;
            min-width: 300px;
            padding: 15px;
            box-sizing: border-box;
            background: #f4f4f4;
            height: 100vh;
            overflow-y: auto;
        }
        h2 { margin-top: 0; }
        #status { font-weight: bold; }
        button {
            width: 100%; padding: 10px; font-size: 16px;
            margin-bottom: 10px; cursor: pointer;
        }
        #find-path-btn { background: #007bff; color: white; border: none; }
        #find-path-btn:disabled { background: #ccc; }
        #reset-btn { background: #dc3545; color: white; border: none; }
        
        /* --- Dropdown Styles --- */
        label { font-weight: bold; margin-top: 10px; display: block; }
        select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        /* --- Result Box Styles --- */
        .result-box {
            border: 2px solid #007bff;
            padding: 10px;
            margin-top: 15px;
            border-radius: 5px;
            display: none; /* Starts hidden */
        }
        .result-box h4 { margin: 0 0 5px 0; }
        .result-box p { margin: 3px 0; }
        .eta { font-size: 1.3em; font-weight: bold; color: #333; }
        
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="sidebar">
        <h2>Emergency Router</h2>
        <p>1. Click map for **Accident (Start)**.</p>
        <p>2. Click again for **Hospital (End)**.</p>
        
        <p><b>Start:</b> <span id="start-node">None</span></p>
        <p><b>End:</b> <span id="end-node">None</span></p>
        
        <label for="method-select">Routing Method:</label>
        <select id="method-select">
            <option value="model_a" selected>Model A (GRU - Fastest)</option>
            <option value="model_b">Model B (GCN-GRU)</option>
            <option value="naive">Naive (Shortest Distance)</option>
        </select>
        
        <button id="find-path-btn" disabled>Find Path</button>
        <button id="reset-btn">Reset</button>
        
        <hr>
        <h3>Status</h3>
        <p id="status">Map loaded. Click to select start point.</p>
        
        <div class="result-box" id="result-container">
            <h4 id="result-method-name">Result</h4>
            <p class="eta" id="result-eta">ETA: 0.0 min</p>
            <p class="dist" id="result-dist">Dist: 0.0 km</p>
        </div>
    </div>

<script>
    // --- 1. Initialize Map (Centered on Delhi) ---
    const map = L.map('map').setView([28.6139, 77.2090], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // --- 2. Global Variables ---
    let startMarker = null, endMarker = null;
    let startNodeId = null, endNodeId = null;
    let pathPolyline = null; // We only need one polyline now

    // --- 3. UI Elements ---
    const statusText = document.getElementById('status');
    const startNodeText = document.getElementById('start-node');
    const endNodeText = document.getElementById('end-node');
    const findPathBtn = document.getElementById('find-path-btn');
    const resetBtn = document.getElementById('reset-btn');
    const methodSelect = document.getElementById('method-select'); // The dropdown
    
    const resultContainer = document.getElementById('result-container');
    const resultMethodName = document.getElementById('result-method-name');
    const resultEta = document.getElementById('result-eta');
    const resultDist = document.getElementById('result-dist');


    // --- 4. Helper: Find Nearest Node (via API) ---
    async function findNearestNodeOnServer(lat, lon) {
        statusText.textContent = "Finding nearest intersection...";
        try {
            const response = await fetch('/api/get_nearest_node', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat: lat, lon: lon })
            });
            if (!response.ok) throw new Error('Server error finding node');
            
            const node = await response.json();
            statusText.textContent = "Node found.";
            return node;
        } catch (error) {
            console.error(error);
            statusText.textContent = `Error: ${error.message}`;
            return null;
        }
    }

    // --- 5. Map Click Handler (Unchanged) ---
    map.on('click', async (e) => {
        const { lat, lng } = e.latlng;
        if (startMarker && endMarker) return;
        
        const nearestNode = await findNearestNodeOnServer(lat, lng);
        if (!nearestNode) return;

        const nodeLatLng = [nearestNode.lat, nearestNode.lon];
        
        if (!startMarker) {
            startMarker = L.marker(nodeLatLng, { title: 'Accident (Start)' }).addTo(map);
            startNodeId = nearestNode.id;
            startNodeText.textContent = `ID ${nearestNode.id}`;
            statusText.textContent = "Click map to set Hospital (End).";
        } else {
            endMarker = L.marker(nodeLatLng, { title: 'Hospital (End)' }).addTo(map);
            endNodeId = nearestNode.id;
            endNodeText.textContent = `ID ${nearestNode.id}`;
            statusText.textContent = "Ready to find path.";
            findPathBtn.disabled = false;
        }
    });

    // --- 6. Button: Find Path (This is your new logic) ---
    findPathBtn.addEventListener('click', async () => {
        if (!startNodeId || !endNodeId) return;
        
        const selectedMethod = methodSelect.value; // Get the dropdown value
        
        statusText.textContent = `Calculating path using ${selectedMethod}...`;
        findPathBtn.disabled = true; // Disable button during calculation
        resetPath(); // Clear old path
        
        try {
            const response = await fetch('/api/find_path', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    start_node_id: startNodeId,
                    end_node_id: endNodeId,
                    method: selectedMethod // Send the method to the backend
                })
            });
            
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Server error');
            }
            
            const data = await response.json();
            
            // --- Determine Color ---
            let color = '#003d99'; // Default Naive
            let borderColor = '#003d99';
            if (data.method_name.includes("Model A")) {
                color = '#d90000';
                borderColor = '#d90000';
            }
            if (data.method_name.includes("Model B")) {
                color = '#008a00';
                borderColor = '#008a00';
            }

            // --- Draw the Path ---
            pathPolyline = L.polyline(data.path_coords, { 
                color: color, weight: 5, opacity: 0.8
            }).addTo(map);

            map.fitBounds(pathPolyline.getBounds());
            
            // --- UPDATE UI TEXT ---
            resultMethodName.textContent = data.method_name;
            resultEta.textContent = `ETA: ${data.eta_minutes.toFixed(1)} min`;
            resultDist.textContent = `Dist: ${data.distance_km.toFixed(1)} km`;
            
            // Style the result box
            resultContainer.style.borderColor = borderColor;
            resultContainer.querySelector('.eta').style.color = color;
            
            statusText.textContent = "Path found!";
            resultContainer.style.display = 'block'; // Show the result
            
        } catch (error) {
            console.error(error);
            statusText.textContent = `Error: ${error.message}`;
        }
        
        findPathBtn.disabled = false; // Re-enable button
    });

    // --- 7. Button: Reset (UPDATED) ---
    function resetPath() {
        if (pathPolyline) map.removeLayer(pathPolyline);
        pathPolyline = null;
    }

    resetBtn.addEventListener('click', () => {
        resetPath();
        if (startMarker) map.removeLayer(startMarker);
        if (endMarker) map.removeLayer(endMarker);
        
        startMarker = null;
        endMarker = null;
        startNodeId = null;
        endNodeId = null;
        
        startNodeText.textContent = "None";
        endNodeText.textContent = "None";
        statusText.textContent = "Click map to set Accident (Start).";
        findPathBtn.disabled = true;
        resultContainer.style.display = 'none'; // Hide result
    });

</script>

</body>
</html>